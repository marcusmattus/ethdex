{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Server = void 0;\n\nvar url = __importStar(require(\"url\"));\n\nvar browser_or_node_1 = require(\"browser-or-node\");\n\nvar jsonrpc_client_websocket_1 = require(\"@airswap/jsonrpc-client-websocket\");\n\nvar constants_1 = require(\"@airswap/constants\");\n\nvar utils_1 = require(\"@airswap/utils\");\n\nvar Light_1 = require(\"./Light\");\n\nvar tiny_typed_emitter_1 = require(\"tiny-typed-emitter\");\n\nif (!browser_or_node_1.isBrowser) {\n  jsonrpc_client_websocket_1.JsonRpcWebsocket.setWebSocketFactory(function (url) {\n    var ws = require('websocket').w3cwebsocket;\n\n    return new ws(url);\n  });\n}\n\nvar PROTOCOL_NAMES = {\n  'last-look': 'Last Look',\n  'request-for-quote': 'Request for Quote'\n};\n\nvar Server =\n/** @class */\nfunction (_super) {\n  __extends(Server, _super);\n\n  function Server(locator, swapContract) {\n    if (swapContract === void 0) {\n      swapContract = Light_1.Light.getAddress();\n    }\n\n    var _this = _super.call(this) || this;\n\n    _this.locator = locator;\n    _this.swapContract = swapContract;\n    var protocol = utils_1.parseUrl(locator).protocol;\n    _this.transportProtocol = protocol.startsWith('http') ? 'http' : 'websocket';\n    return _this;\n  }\n\n  Server.at = function (locator, options) {\n    return __awaiter(this, void 0, void 0, function () {\n      var server;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            server = new Server(locator, options === null || options === void 0 ? void 0 : options.swapContract);\n            return [4\n            /*yield*/\n            , server._init(options === null || options === void 0 ? void 0 : options.initializeTimeout)];\n\n          case 1:\n            _a.sent();\n\n            return [2\n            /*return*/\n            , server];\n        }\n      });\n    });\n  };\n\n  Server.prototype.getSupportedProtocolVersion = function (protocol) {\n    // Don't check supportedProtocols unless the server has initialized.\n    // Important for WebSocket servers that can support either RFQ or Last Look\n    this.requireInitialized();\n    var supportedProtocolInfo = this.supportedProtocols.find(function (p) {\n      return p.name === protocol;\n    });\n    if (!supportedProtocolInfo) return null;\n    return supportedProtocolInfo.version;\n  };\n\n  Server.prototype.supportsProtocol = function (protocol, requestedVersion) {\n    var supportedVersion = this.getSupportedProtocolVersion(protocol);\n    if (!supportedVersion) return false;\n    if (!requestedVersion) return true;\n\n    var _a = /(\\d+)\\.(\\d+)\\.(\\d+)/.exec(requestedVersion),\n        wantedMajor = _a[1],\n        wantedMinor = _a[2],\n        wantedPatch = _a[3];\n\n    var _b = /(\\d+)\\.(\\d+)\\.(\\d+)/.exec(supportedVersion),\n        supportedMajor = _b[1],\n        supportedMinor = _b[2],\n        supportedPatch = _b[3];\n\n    if (wantedMajor !== supportedMajor) return false;\n    if (parseInt(wantedMinor) > parseInt(supportedMinor)) return false;\n    if (parseInt(wantedPatch) > parseInt(supportedPatch)) return false;\n    return true;\n  };\n\n  Server.prototype.getMaxQuote = function (signerToken, senderToken) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        this.requireRFQSupport();\n        return [2\n        /*return*/\n        , this.callRPCMethod('getMaxQuote', {\n          signerToken: signerToken,\n          senderToken: senderToken\n        })];\n      });\n    });\n  };\n\n  Server.prototype.getSignerSideQuote = function (senderAmount, signerToken, senderToken) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        this.requireRFQSupport();\n        return [2\n        /*return*/\n        , this.callRPCMethod('getSignerSideQuote', {\n          senderAmount: senderAmount.toString(),\n          signerToken: signerToken,\n          senderToken: senderToken\n        })];\n      });\n    });\n  };\n\n  Server.prototype.getSenderSideQuote = function (signerAmount, signerToken, senderToken) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        this.requireRFQSupport();\n        return [2\n        /*return*/\n        , this.callRPCMethod('getSenderSideQuote', {\n          signerAmount: signerAmount.toString(),\n          signerToken: signerToken,\n          senderToken: senderToken\n        })];\n      });\n    });\n  };\n\n  Server.prototype.getSignerSideOrder = function (senderAmount, signerToken, senderToken, senderWallet) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        this.requireRFQSupport();\n        return [2\n        /*return*/\n        , this.callRPCMethod('getSignerSideOrder', {\n          senderAmount: senderAmount.toString(),\n          signerToken: signerToken,\n          senderToken: senderToken,\n          senderWallet: senderWallet\n        }).then(function (order) {\n          return utils_1.orderPropsToStrings(order);\n        })];\n      });\n    });\n  };\n\n  Server.prototype.getSenderSideOrder = function (signerAmount, signerToken, senderToken, senderWallet) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        this.requireRFQSupport();\n        return [2\n        /*return*/\n        , this.callRPCMethod('getSenderSideOrder', {\n          signerAmount: signerAmount.toString(),\n          signerToken: signerToken,\n          senderToken: senderToken,\n          senderWallet: senderWallet\n        }).then(function (order) {\n          return utils_1.orderPropsToStrings(order);\n        })];\n      });\n    });\n  };\n\n  Server.prototype.subscribe = function (pairs) {\n    return __awaiter(this, void 0, void 0, function () {\n      var pricing;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            this.requireLastLookSupport();\n            return [4\n            /*yield*/\n            , this.callRPCMethod('subscribe', [pairs])];\n\n          case 1:\n            pricing = _a.sent();\n            this.emit('pricing', pricing);\n            return [2\n            /*return*/\n            , pricing];\n        }\n      });\n    });\n  };\n\n  Server.prototype.unsubscribe = function (pairs) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        this.requireLastLookSupport();\n        return [2\n        /*return*/\n        , this.callRPCMethod('unsubscribe', [pairs])];\n      });\n    });\n  };\n\n  Server.prototype.subscribeAll = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        this.requireLastLookSupport();\n        return [2\n        /*return*/\n        , this.callRPCMethod('subscribeAll')];\n      });\n    });\n  };\n\n  Server.prototype.unsubscribeAll = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        this.requireLastLookSupport();\n        return [2\n        /*return*/\n        , this.callRPCMethod('unsubscribeAll')];\n      });\n    });\n  };\n\n  Server.prototype.getSenderWallet = function () {\n    this.requireLastLookSupport();\n    return this.senderWallet;\n  };\n\n  Server.prototype.consider = function (order) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        this.requireLastLookSupport();\n        return [2\n        /*return*/\n        , this.callRPCMethod('consider', order)];\n      });\n    });\n  };\n\n  Server.prototype.disconnect = function () {\n    var _this = this;\n\n    if (this.webSocketClient) {\n      if (this.webSocketClient.state !== jsonrpc_client_websocket_1.WebsocketReadyStates.CLOSED) {\n        this.webSocketClient.close(); // Note that we remove listeners only after close as closing before a\n        // successful connection will emit an error, and emitting an error\n        // without a listener will throw. Removing listeners before close means\n        // closing before connecting would cause an unpreventable throw (error\n        // listener would be removed first).\n\n        this.webSocketClient.on('close', function () {\n          _this.removeAllListeners();\n        });\n      } else {\n        this.removeAllListeners();\n      }\n\n      delete this.webSocketClient;\n    }\n  };\n\n  Server.prototype._init = function (initializeTimeout) {\n    if (initializeTimeout === void 0) {\n      initializeTimeout = constants_1.REQUEST_TIMEOUT;\n    }\n\n    if (this.transportProtocol === 'http') {\n      return this._initHTTPClient(this.locator);\n    } else {\n      return this._initWebSocketClient(this.locator, initializeTimeout);\n    }\n  };\n\n  Server.prototype._initHTTPClient = function (locator, clientOnly) {\n    // clientOnly flag set when initializing client for last look `senderServer`\n    var parsedUrl = utils_1.parseUrl(locator);\n    var options = {\n      protocol: parsedUrl.protocol,\n      hostname: parsedUrl.hostname,\n      port: parsedUrl.port,\n      timeout: constants_1.REQUEST_TIMEOUT\n    };\n\n    if (!clientOnly) {\n      this.supportedProtocols = [{\n        name: 'request-for-quote',\n        version: '2.0.0'\n      }];\n      this.isInitialized = true;\n    }\n\n    if (browser_or_node_1.isBrowser) {\n      var jaysonClient = require('jayson/lib/client/browser');\n\n      this.httpClient = new jaysonClient(function (request, callback) {\n        fetch(url.format(parsedUrl), {\n          method: 'POST',\n          body: request,\n          headers: {\n            'Content-Type': 'application/json'\n          }\n        }).then(function (res) {\n          return res.text();\n        }).then(function (text) {\n          callback(null, text);\n        }).catch(function (err) {\n          callback(err);\n        });\n      }, options);\n    } else {\n      var jaysonClient = require('jayson/lib/client');\n\n      if (options.protocol === 'https:') {\n        this.httpClient = jaysonClient.https(options);\n      } else {\n        this.httpClient = jaysonClient.http(options);\n      }\n    }\n  };\n\n  Server.prototype._initWebSocketClient = function (locator, initializeTimeout) {\n    return __awaiter(this, void 0, void 0, function () {\n      var initPromise;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            initPromise = new Promise(function (resolve, reject) {\n              _this.webSocketClient = new jsonrpc_client_websocket_1.JsonRpcWebsocket(url.format(locator), constants_1.REQUEST_TIMEOUT, function (error) {\n                if (!_this.isInitialized) {\n                  reject(error);\n                } else {\n                  _this.emit('error', error);\n                }\n              });\n              var initTimeout = setTimeout(function () {\n                reject('Server did not call initialize in time');\n\n                _this.disconnect();\n              }, initializeTimeout);\n\n              _this.webSocketClient.on('initialize', function (message) {\n                clearTimeout(initTimeout);\n\n                try {\n                  _this.initialize(message);\n\n                  _this.isInitialized = true;\n                  resolve(_this.supportedProtocols);\n                  return true;\n                } catch (e) {\n                  reject(e);\n                  return false;\n                }\n              });\n            });\n            this.webSocketClient.on('updatePricing', this.updatePricing.bind(this));\n            return [4\n            /*yield*/\n            , this.webSocketClient.open()];\n\n          case 1:\n            _a.sent();\n\n            return [4\n            /*yield*/\n            , initPromise];\n\n          case 2:\n            _a.sent();\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  Server.prototype.requireInitialized = function () {\n    if (!this.isInitialized) throw new Error('Server not yet initialized');\n  };\n\n  Server.prototype.requireRFQSupport = function (version) {\n    this.requireProtocolSupport('request-for-quote', version);\n  };\n\n  Server.prototype.requireLastLookSupport = function (version) {\n    this.requireProtocolSupport('last-look', version);\n  };\n\n  Server.prototype.requireProtocolSupport = function (protocol, version) {\n    if (!this.supportsProtocol(protocol, version)) {\n      var supportedVersion = this.getSupportedProtocolVersion(protocol);\n      var message = void 0;\n\n      if (supportedVersion) {\n        message = \"Server at \" + this.locator + \" doesn't support \" + (PROTOCOL_NAMES[protocol] + \" v\" + version) + (\"supported version \" + supportedVersion);\n      } else {\n        message = \"Server at \" + this.locator + \" doesn't \" + (\"support \" + PROTOCOL_NAMES[protocol]);\n      }\n\n      throw new Error(message);\n    }\n  };\n\n  Server.prototype.compare = function (params, result) {\n    var errors = [];\n    var flat = utils_1.flattenObject(result);\n\n    for (var param in params) {\n      if (param in flat && flat[param].toLowerCase() !== params[param].toLowerCase()) {\n        errors.push(param);\n      }\n    }\n\n    return errors;\n  };\n\n  Server.prototype.throwInvalidParams = function (method, params) {\n    throw {\n      code: jsonrpc_client_websocket_1.JsonRpcErrorCodes.INVALID_PARAMS,\n      message: \"Received invalid param format or values for method \\\"\" + method + \"\\\": \" + params\n    };\n  };\n\n  Server.prototype.validateInitializeParams = function (params) {\n    var valid = true;\n    if (!Array.isArray(params)) valid = false;\n    if (valid && !params.every(function (protocolInfo) {\n      return protocolInfo.version && protocolInfo.name;\n    })) valid = false;\n    if (!valid) this.throwInvalidParams('initialize', JSON.stringify(params));\n  };\n\n  Server.prototype.validateUpdatePricingParams = function (params) {\n    var valid = true;\n    if (!Array.isArray(params)) valid = false;\n    if (valid && !params.every(function (pricing) {\n      return pricing.baseToken && pricing.quoteToken && Array.isArray(pricing.bid) && Array.isArray(pricing.ask);\n    })) valid = false;\n    if (!valid) this.throwInvalidParams('updatePricing', JSON.stringify(params));\n  };\n\n  Server.prototype.updatePricing = function (newPricing) {\n    this.validateUpdatePricingParams(newPricing);\n    this.emit('pricing', newPricing);\n    return true;\n  };\n\n  Server.prototype.initialize = function (supportedProtocols) {\n    var _a, _b;\n\n    this.validateInitializeParams(supportedProtocols);\n    this.supportedProtocols = supportedProtocols;\n    var lastLookSupport = supportedProtocols.find(function (protocol) {\n      return protocol.name === 'last-look';\n    });\n\n    if ((_a = lastLookSupport === null || lastLookSupport === void 0 ? void 0 : lastLookSupport.params) === null || _a === void 0 ? void 0 : _a.senderServer) {\n      this.senderServer = lastLookSupport.params.senderServer; // Prepare an http client for consider calls.\n\n      this._initHTTPClient(this.senderServer, true);\n    }\n\n    if ((_b = lastLookSupport === null || lastLookSupport === void 0 ? void 0 : lastLookSupport.params) === null || _b === void 0 ? void 0 : _b.senderWallet) {\n      this.senderWallet = lastLookSupport.params.senderWallet;\n    }\n  };\n\n  Server.prototype.httpCall = function (method, params) {\n    var _this = this;\n\n    if (!Array.isArray(params)) {\n      params.swapContract = this.swapContract;\n    }\n\n    return new Promise(function (resolve, reject) {\n      _this.httpClient.request(method, params, function (connectionError, serverError, result) {\n        if (connectionError) {\n          reject({\n            code: -1,\n            message: connectionError.message\n          });\n        } else if (serverError) {\n          reject(serverError);\n        } else {\n          var errors = _this.compare(params, result);\n\n          if (errors.length) {\n            reject({\n              code: -1,\n              message: \"Server response differs from request params: \" + errors\n            });\n          } else {\n            if (method.indexOf('Quote') !== -1 && !utils_1.isValidQuote(result)) {\n              reject({\n                code: -1,\n                message: \"Server response is not a valid quote: \" + JSON.stringify(result)\n              });\n            } else {\n              resolve(result);\n            }\n          }\n        }\n      });\n    });\n  };\n\n  Server.prototype.webSocketCall = function (method, params) {\n    return __awaiter(this, void 0, void 0, function () {\n      var response;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.webSocketClient.call(method, params)];\n\n          case 1:\n            response = _a.sent();\n            return [2\n            /*return*/\n            , response.result];\n        }\n      });\n    });\n  };\n  /**\n   * This method should instantiate the relevenat transport client and also\n   * trigger initialization, setting `isInitialized` when complete.\n   */\n\n\n  Server.prototype.callRPCMethod = function (method, params) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        if (this.transportProtocol === 'http' || method === 'consider' && this.senderServer) {\n          return [2\n          /*return*/\n          , this.httpCall(method, params)];\n        } else {\n          return [2\n          /*return*/\n          , this.webSocketCall(method, params)];\n        }\n\n        return [2\n        /*return*/\n        ];\n      });\n    });\n  };\n\n  return Server;\n}(tiny_typed_emitter_1.TypedEmitter);\n\nexports.Server = Server;","map":{"version":3,"sources":["../../src/Server.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.Server = void 0;\nvar url = __importStar(require(\"url\"));\nvar browser_or_node_1 = require(\"browser-or-node\");\nvar jsonrpc_client_websocket_1 = require(\"@airswap/jsonrpc-client-websocket\");\nvar constants_1 = require(\"@airswap/constants\");\nvar utils_1 = require(\"@airswap/utils\");\nvar Light_1 = require(\"./Light\");\nvar tiny_typed_emitter_1 = require(\"tiny-typed-emitter\");\nif (!browser_or_node_1.isBrowser) {\n    jsonrpc_client_websocket_1.JsonRpcWebsocket.setWebSocketFactory(function (url) {\n        var ws = require('websocket').w3cwebsocket;\n        return new ws(url);\n    });\n}\nvar PROTOCOL_NAMES = {\n    'last-look': 'Last Look',\n    'request-for-quote': 'Request for Quote',\n};\nvar Server = /** @class */ (function (_super) {\n    __extends(Server, _super);\n    function Server(locator, swapContract) {\n        if (swapContract === void 0) { swapContract = Light_1.Light.getAddress(); }\n        var _this = _super.call(this) || this;\n        _this.locator = locator;\n        _this.swapContract = swapContract;\n        var protocol = utils_1.parseUrl(locator).protocol;\n        _this.transportProtocol = protocol.startsWith('http') ? 'http' : 'websocket';\n        return _this;\n    }\n    Server.at = function (locator, options) {\n        return __awaiter(this, void 0, void 0, function () {\n            var server;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        server = new Server(locator, options === null || options === void 0 ? void 0 : options.swapContract);\n                        return [4 /*yield*/, server._init(options === null || options === void 0 ? void 0 : options.initializeTimeout)];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/, server];\n                }\n            });\n        });\n    };\n    Server.prototype.getSupportedProtocolVersion = function (protocol) {\n        // Don't check supportedProtocols unless the server has initialized.\n        // Important for WebSocket servers that can support either RFQ or Last Look\n        this.requireInitialized();\n        var supportedProtocolInfo = this.supportedProtocols.find(function (p) { return p.name === protocol; });\n        if (!supportedProtocolInfo)\n            return null;\n        return supportedProtocolInfo.version;\n    };\n    Server.prototype.supportsProtocol = function (protocol, requestedVersion) {\n        var supportedVersion = this.getSupportedProtocolVersion(protocol);\n        if (!supportedVersion)\n            return false;\n        if (!requestedVersion)\n            return true;\n        var _a = /(\\d+)\\.(\\d+)\\.(\\d+)/.exec(requestedVersion), wantedMajor = _a[1], wantedMinor = _a[2], wantedPatch = _a[3];\n        var _b = /(\\d+)\\.(\\d+)\\.(\\d+)/.exec(supportedVersion), supportedMajor = _b[1], supportedMinor = _b[2], supportedPatch = _b[3];\n        if (wantedMajor !== supportedMajor)\n            return false;\n        if (parseInt(wantedMinor) > parseInt(supportedMinor))\n            return false;\n        if (parseInt(wantedPatch) > parseInt(supportedPatch))\n            return false;\n        return true;\n    };\n    Server.prototype.getMaxQuote = function (signerToken, senderToken) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                this.requireRFQSupport();\n                return [2 /*return*/, this.callRPCMethod('getMaxQuote', {\n                        signerToken: signerToken,\n                        senderToken: senderToken,\n                    })];\n            });\n        });\n    };\n    Server.prototype.getSignerSideQuote = function (senderAmount, signerToken, senderToken) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                this.requireRFQSupport();\n                return [2 /*return*/, this.callRPCMethod('getSignerSideQuote', {\n                        senderAmount: senderAmount.toString(),\n                        signerToken: signerToken,\n                        senderToken: senderToken,\n                    })];\n            });\n        });\n    };\n    Server.prototype.getSenderSideQuote = function (signerAmount, signerToken, senderToken) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                this.requireRFQSupport();\n                return [2 /*return*/, this.callRPCMethod('getSenderSideQuote', {\n                        signerAmount: signerAmount.toString(),\n                        signerToken: signerToken,\n                        senderToken: senderToken,\n                    })];\n            });\n        });\n    };\n    Server.prototype.getSignerSideOrder = function (senderAmount, signerToken, senderToken, senderWallet) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                this.requireRFQSupport();\n                return [2 /*return*/, this.callRPCMethod('getSignerSideOrder', {\n                        senderAmount: senderAmount.toString(),\n                        signerToken: signerToken,\n                        senderToken: senderToken,\n                        senderWallet: senderWallet,\n                    }).then(function (order) {\n                        return utils_1.orderPropsToStrings(order);\n                    })];\n            });\n        });\n    };\n    Server.prototype.getSenderSideOrder = function (signerAmount, signerToken, senderToken, senderWallet) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                this.requireRFQSupport();\n                return [2 /*return*/, this.callRPCMethod('getSenderSideOrder', {\n                        signerAmount: signerAmount.toString(),\n                        signerToken: signerToken,\n                        senderToken: senderToken,\n                        senderWallet: senderWallet,\n                    }).then(function (order) {\n                        return utils_1.orderPropsToStrings(order);\n                    })];\n            });\n        });\n    };\n    Server.prototype.subscribe = function (pairs) {\n        return __awaiter(this, void 0, void 0, function () {\n            var pricing;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        this.requireLastLookSupport();\n                        return [4 /*yield*/, this.callRPCMethod('subscribe', [pairs])];\n                    case 1:\n                        pricing = _a.sent();\n                        this.emit('pricing', pricing);\n                        return [2 /*return*/, pricing];\n                }\n            });\n        });\n    };\n    Server.prototype.unsubscribe = function (pairs) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                this.requireLastLookSupport();\n                return [2 /*return*/, this.callRPCMethod('unsubscribe', [pairs])];\n            });\n        });\n    };\n    Server.prototype.subscribeAll = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                this.requireLastLookSupport();\n                return [2 /*return*/, this.callRPCMethod('subscribeAll')];\n            });\n        });\n    };\n    Server.prototype.unsubscribeAll = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                this.requireLastLookSupport();\n                return [2 /*return*/, this.callRPCMethod('unsubscribeAll')];\n            });\n        });\n    };\n    Server.prototype.getSenderWallet = function () {\n        this.requireLastLookSupport();\n        return this.senderWallet;\n    };\n    Server.prototype.consider = function (order) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                this.requireLastLookSupport();\n                return [2 /*return*/, this.callRPCMethod('consider', order)];\n            });\n        });\n    };\n    Server.prototype.disconnect = function () {\n        var _this = this;\n        if (this.webSocketClient) {\n            if (this.webSocketClient.state !== jsonrpc_client_websocket_1.WebsocketReadyStates.CLOSED) {\n                this.webSocketClient.close();\n                // Note that we remove listeners only after close as closing before a\n                // successful connection will emit an error, and emitting an error\n                // without a listener will throw. Removing listeners before close means\n                // closing before connecting would cause an unpreventable throw (error\n                // listener would be removed first).\n                this.webSocketClient.on('close', function () {\n                    _this.removeAllListeners();\n                });\n            }\n            else {\n                this.removeAllListeners();\n            }\n            delete this.webSocketClient;\n        }\n    };\n    Server.prototype._init = function (initializeTimeout) {\n        if (initializeTimeout === void 0) { initializeTimeout = constants_1.REQUEST_TIMEOUT; }\n        if (this.transportProtocol === 'http') {\n            return this._initHTTPClient(this.locator);\n        }\n        else {\n            return this._initWebSocketClient(this.locator, initializeTimeout);\n        }\n    };\n    Server.prototype._initHTTPClient = function (locator, clientOnly) {\n        // clientOnly flag set when initializing client for last look `senderServer`\n        var parsedUrl = utils_1.parseUrl(locator);\n        var options = {\n            protocol: parsedUrl.protocol,\n            hostname: parsedUrl.hostname,\n            port: parsedUrl.port,\n            timeout: constants_1.REQUEST_TIMEOUT,\n        };\n        if (!clientOnly) {\n            this.supportedProtocols = [\n                { name: 'request-for-quote', version: '2.0.0' },\n            ];\n            this.isInitialized = true;\n        }\n        if (browser_or_node_1.isBrowser) {\n            var jaysonClient = require('jayson/lib/client/browser');\n            this.httpClient = new jaysonClient(function (request, callback) {\n                fetch(url.format(parsedUrl), {\n                    method: 'POST',\n                    body: request,\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                })\n                    .then(function (res) {\n                    return res.text();\n                })\n                    .then(function (text) {\n                    callback(null, text);\n                })\n                    .catch(function (err) {\n                    callback(err);\n                });\n            }, options);\n        }\n        else {\n            var jaysonClient = require('jayson/lib/client');\n            if (options.protocol === 'https:') {\n                this.httpClient = jaysonClient.https(options);\n            }\n            else {\n                this.httpClient = jaysonClient.http(options);\n            }\n        }\n    };\n    Server.prototype._initWebSocketClient = function (locator, initializeTimeout) {\n        return __awaiter(this, void 0, void 0, function () {\n            var initPromise;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        initPromise = new Promise(function (resolve, reject) {\n                            _this.webSocketClient = new jsonrpc_client_websocket_1.JsonRpcWebsocket(url.format(locator), constants_1.REQUEST_TIMEOUT, function (error) {\n                                if (!_this.isInitialized) {\n                                    reject(error);\n                                }\n                                else {\n                                    _this.emit('error', error);\n                                }\n                            });\n                            var initTimeout = setTimeout(function () {\n                                reject('Server did not call initialize in time');\n                                _this.disconnect();\n                            }, initializeTimeout);\n                            _this.webSocketClient.on('initialize', function (message) {\n                                clearTimeout(initTimeout);\n                                try {\n                                    _this.initialize(message);\n                                    _this.isInitialized = true;\n                                    resolve(_this.supportedProtocols);\n                                    return true;\n                                }\n                                catch (e) {\n                                    reject(e);\n                                    return false;\n                                }\n                            });\n                        });\n                        this.webSocketClient.on('updatePricing', this.updatePricing.bind(this));\n                        return [4 /*yield*/, this.webSocketClient.open()];\n                    case 1:\n                        _a.sent();\n                        return [4 /*yield*/, initPromise];\n                    case 2:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    Server.prototype.requireInitialized = function () {\n        if (!this.isInitialized)\n            throw new Error('Server not yet initialized');\n    };\n    Server.prototype.requireRFQSupport = function (version) {\n        this.requireProtocolSupport('request-for-quote', version);\n    };\n    Server.prototype.requireLastLookSupport = function (version) {\n        this.requireProtocolSupport('last-look', version);\n    };\n    Server.prototype.requireProtocolSupport = function (protocol, version) {\n        if (!this.supportsProtocol(protocol, version)) {\n            var supportedVersion = this.getSupportedProtocolVersion(protocol);\n            var message = void 0;\n            if (supportedVersion) {\n                message =\n                    \"Server at \" + this.locator + \" doesn't support \" +\n                        (PROTOCOL_NAMES[protocol] + \" v\" + version) +\n                        (\"supported version \" + supportedVersion);\n            }\n            else {\n                message =\n                    \"Server at \" + this.locator + \" doesn't \" +\n                        (\"support \" + PROTOCOL_NAMES[protocol]);\n            }\n            throw new Error(message);\n        }\n    };\n    Server.prototype.compare = function (params, result) {\n        var errors = [];\n        var flat = utils_1.flattenObject(result);\n        for (var param in params) {\n            if (param in flat &&\n                flat[param].toLowerCase() !== params[param].toLowerCase()) {\n                errors.push(param);\n            }\n        }\n        return errors;\n    };\n    Server.prototype.throwInvalidParams = function (method, params) {\n        throw {\n            code: jsonrpc_client_websocket_1.JsonRpcErrorCodes.INVALID_PARAMS,\n            message: \"Received invalid param format or values for method \\\"\" + method + \"\\\": \" + params,\n        };\n    };\n    Server.prototype.validateInitializeParams = function (params) {\n        var valid = true;\n        if (!Array.isArray(params))\n            valid = false;\n        if (valid &&\n            !params.every(function (protocolInfo) { return protocolInfo.version && protocolInfo.name; }))\n            valid = false;\n        if (!valid)\n            this.throwInvalidParams('initialize', JSON.stringify(params));\n    };\n    Server.prototype.validateUpdatePricingParams = function (params) {\n        var valid = true;\n        if (!Array.isArray(params))\n            valid = false;\n        if (valid &&\n            !params.every(function (pricing) {\n                return pricing.baseToken &&\n                    pricing.quoteToken &&\n                    Array.isArray(pricing.bid) &&\n                    Array.isArray(pricing.ask);\n            }))\n            valid = false;\n        if (!valid)\n            this.throwInvalidParams('updatePricing', JSON.stringify(params));\n    };\n    Server.prototype.updatePricing = function (newPricing) {\n        this.validateUpdatePricingParams(newPricing);\n        this.emit('pricing', newPricing);\n        return true;\n    };\n    Server.prototype.initialize = function (supportedProtocols) {\n        var _a, _b;\n        this.validateInitializeParams(supportedProtocols);\n        this.supportedProtocols = supportedProtocols;\n        var lastLookSupport = supportedProtocols.find(function (protocol) { return protocol.name === 'last-look'; });\n        if ((_a = lastLookSupport === null || lastLookSupport === void 0 ? void 0 : lastLookSupport.params) === null || _a === void 0 ? void 0 : _a.senderServer) {\n            this.senderServer = lastLookSupport.params.senderServer;\n            // Prepare an http client for consider calls.\n            this._initHTTPClient(this.senderServer, true);\n        }\n        if ((_b = lastLookSupport === null || lastLookSupport === void 0 ? void 0 : lastLookSupport.params) === null || _b === void 0 ? void 0 : _b.senderWallet) {\n            this.senderWallet = lastLookSupport.params.senderWallet;\n        }\n    };\n    Server.prototype.httpCall = function (method, params) {\n        var _this = this;\n        if (!Array.isArray(params)) {\n            params.swapContract = this.swapContract;\n        }\n        return new Promise(function (resolve, reject) {\n            _this.httpClient.request(method, params, function (connectionError, serverError, result) {\n                if (connectionError) {\n                    reject({ code: -1, message: connectionError.message });\n                }\n                else if (serverError) {\n                    reject(serverError);\n                }\n                else {\n                    var errors = _this.compare(params, result);\n                    if (errors.length) {\n                        reject({\n                            code: -1,\n                            message: \"Server response differs from request params: \" + errors,\n                        });\n                    }\n                    else {\n                        if (method.indexOf('Quote') !== -1 && !utils_1.isValidQuote(result)) {\n                            reject({\n                                code: -1,\n                                message: \"Server response is not a valid quote: \" + JSON.stringify(result),\n                            });\n                        }\n                        else {\n                            resolve(result);\n                        }\n                    }\n                }\n            });\n        });\n    };\n    Server.prototype.webSocketCall = function (method, params) {\n        return __awaiter(this, void 0, void 0, function () {\n            var response;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.webSocketClient.call(method, params)];\n                    case 1:\n                        response = _a.sent();\n                        return [2 /*return*/, response.result];\n                }\n            });\n        });\n    };\n    /**\n     * This method should instantiate the relevenat transport client and also\n     * trigger initialization, setting `isInitialized` when complete.\n     */\n    Server.prototype.callRPCMethod = function (method, params) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                if (this.transportProtocol === 'http' ||\n                    (method === 'consider' && this.senderServer)) {\n                    return [2 /*return*/, this.httpCall(method, params)];\n                }\n                else {\n                    return [2 /*return*/, this.webSocketCall(method, params)];\n                }\n                return [2 /*return*/];\n            });\n        });\n    };\n    return Server;\n}(tiny_typed_emitter_1.TypedEmitter));\nexports.Server = Server;\n//# sourceMappingURL=Server.js.map"]},"metadata":{},"sourceType":"script"}